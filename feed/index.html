<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>A blog</title>
    <description>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</description>
    <link>http://yourdomain.com/</link>
    <atom:link href="http://yourdomain.com/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Fri, 30 Nov 2018 22:22:05 +0000</pubDate>
    <lastBuildDate>Fri, 30 Nov 2018 22:22:05 +0000</lastBuildDate>
    <generator>Jekyll v2.5.3</generator>
    
      <item>
        <title>Serial LIRC devices on recent Ubuntu releases</title>
        <description>&lt;p&gt;I tried to get a “homebrew” infrared receiver attached to the DCD line of a serial port working on Ubuntu Bionic.  It seems that things have changed since Ubuntu 12.04, when I last had it working.&lt;/p&gt;

&lt;p&gt;The changes ended up being:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The kernel modules are in the mainline kernel, but aren’t supplied with Ubuntu&lt;/li&gt;
  &lt;li&gt;The LIRC driver’s name has changed from “serial” to “default”&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;My first problem is that the receiver wasn’t working in the first place.  I attached a DSO Nano to the data line, and noticed that the signal didn’t have a high enough voltage to trigger the serial port.  The &lt;a href=&quot;https://www.mouser.com/ds/2/348/rpm6900-313874.pdf&quot;&gt;data sheet&lt;/a&gt; shows the receiver’s output being a pull-up resistor with a transistor pulling the output low; maybe this serial port draws a particularly large amount of current.  I wired a 2.2k resistor between the data line and VCC (which should be within the limits of the receiver), and everything works.&lt;/p&gt;

&lt;p&gt;I tested it with this program, which displays a time when the DCD line changes:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;sys/stat.h&amp;gt;
#include &amp;lt;fcntl.h&amp;gt;
#include &amp;lt;sys/ioctl.h&amp;gt;
#include &amp;lt;termios.h&amp;gt;
#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;string.h&amp;gt;
#include &amp;lt;errno.h&amp;gt;
#include &amp;lt;time.h&amp;gt;
    
int die(const char* msg) {
  perror(msg);
  printf(&quot;%s\n&quot;, strerror(errno));
  exit(1);
}

int main(void) {
  int fd = open(&quot;/dev/ttyS0&quot;, 0);
  if (fd == -1)
    die(&quot;open&quot;);
  while (1) {
    struct timespec tm;
    ioctl(fd, TIOCMIWAIT, TIOCM_CD | TIOCM_RNG | TIOCM_DSR | TIOCM_CTS);
    if (clock_gettime(CLOCK_MONOTONIC, &amp;amp;tm) == -1)
      die(&quot;clock_gettime&quot;);
    printf(&quot;%ld\n&quot;, tm.tv_nsec);
  }
  close(fd);
  return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(So why does LIRC need the kernel driver, if this works in userspace?  I suspect it’s because the LIRC API requires a timeout, which the &lt;code&gt;ioctl&lt;/code&gt; doesn’t support.)&lt;/p&gt;

&lt;p&gt;LIRC’s serial port support works by using a kernel module to read the hardware, and sends the output to &lt;code&gt;/dev/lirc0&lt;/code&gt;.  LIRC connects to this device to read the input.  The LIRC userspace driver that does this is called “default” (it used to be called “serial”).&lt;/p&gt;

&lt;p&gt;It seems a few releases ago the drivers were upstreamed, and aren’t supplied with Ubuntu.  I got the driver installed with DKMS:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Create a working directory&lt;/li&gt;
  &lt;li&gt;Put the &lt;a href=&quot;https://elixir.bootlin.com/linux/v4.15.18/source/drivers/media/rc/serial_ir.c&quot;&gt;driver&lt;/a&gt; in it.  (Choose the appropriate version for your kernel.)&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Add this Makefile:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; obj-m += serial_ir.o

 all:
 	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules

 clean:
 	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Add this &lt;code&gt;dkms.conf&lt;/code&gt;:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; PACKAGE_NAME=&quot;lirc_serial_ir&quot;
 PACKAGE_VERSION=&quot;4.15&quot;
 CLEAN=&quot;rm -f *.*o&quot;
 BUILT_MODULE_NAME[0]=&quot;serial_ir&quot;
 DEST_MODULE_LOCATION[0]=&quot;/updates&quot;
 AUTOINSTALL=&quot;no&quot;
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;Run &lt;code&gt;sudo dkms add .&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Run &lt;code&gt;sudo dkms install lirc_serial_ir/4.15&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Now run &lt;code&gt;sudo modprobe lirc_serial&lt;/code&gt;.  Run &lt;code&gt;dmesg&lt;/code&gt;, and you should see:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[ 1627.908509] serial_ir serial_ir.0: port 03f8 already in use
[ 1627.908515] serial_ir serial_ir.0: use &#39;setserial /dev/ttySX uart none&#39;
[ 1627.908516] serial_ir serial_ir.0: or compile the serial port driver as module and
[ 1627.908517] serial_ir serial_ir.0: make sure this module is loaded first
[ 1627.908532] serial_ir: probe of serial_ir.0 failed with error -16
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To fix this, install the “setserial” package, and &lt;a href=&quot;http://www.lirc.org/html/configuration-guide.html#serial_port_reservation&quot;&gt;disable the serial port as the instructions say&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Try running mode2, and press some buttons on the remote:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo mode2 --driver default
Using driver default on device auto
Trying device: /dev/lirc0
Using device: /dev/lirc0
Running as regular user
space 504574
pulse 9015
space 4548
pulse 488
&lt;/code&gt;&lt;/pre&gt;

</description>
        <pubDate>Wed, 28 Nov 2018 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2018/11/28/lirc-ubuntu-bionic/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2018/11/28/lirc-ubuntu-bionic/</guid>
        
        
      </item>
    
      <item>
        <title>Sub 50 cent microcontrollers</title>
        <description>&lt;p&gt;&lt;a href=&quot;https://jaycarlson.net/microcontrollers/&quot;&gt;$1 microcontrollers&lt;/a&gt;, pfft.  What useful ones are around for under 50 cents?&lt;/p&gt;

&lt;p&gt;The qualifications:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;There needs to be adequate documentation&lt;/li&gt;
  &lt;li&gt;Programmamble with readly available (and cheap) hardware.  This rules out a lot of ones from Megawin, Sinowealth and so on; while they have reasonable user manuals, there’s no information on how to program them, short of buying a $20 programmer.&lt;/li&gt;
  &lt;li&gt;Are readily available.  I ruled out parts only available from Taobao, for instance.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I was left with these:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The STM8S103.  They’re not &lt;em&gt;the&lt;/em&gt; cheapest, but are readily available in the West.  There’s a cheaper STM8S003, but its flash is rated to only 100 writes, so it sounds like the idea is to develop for the S103 first.&lt;/li&gt;
  &lt;li&gt;The Nuvoton N76E003.  It has loads of peripherals, and is pin compatible with the STM8S103.&lt;/li&gt;
  &lt;li&gt;The STC microcontrollers.  Not quite as much bang for buck as the Nuvoton, and unavailable in the West, but come in 8 pin packages.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The Atmel ATtiny13 also qualifies, but I already know how to program those!&lt;/p&gt;

&lt;p&gt;All should be programmable using &lt;a href=&quot;http://sdcc.sourceforge.net/&quot;&gt;SDCC&lt;/a&gt;, and either a ST-Link or USB-Serial dongle.  I’ve purchased development boards for the &lt;a href=&quot;https://www.aliexpress.com/item/STM8S103F3P6-System-Board-STM8S-STM8-Development-Board-Minimum-Core-Board/32885918852.html&quot;&gt;STM8&lt;/a&gt;, &lt;a href=&quot;https://www.aliexpress.com/item/51-Development-Board-N76E003AT20-Development-Board-System-Board-Core-Board-N76E003/32898770085.html&quot;&gt;Nuvoton&lt;/a&gt; and a &lt;a href=&quot;https://www.aliexpress.com/item/STC15W204S-SCM-Minimum-System-Board-Development-Board-51-SOP8-STC15F104E/32899351974.html&quot;&gt;STC15W204&lt;/a&gt;.  I hope to try these out and write about them.&lt;/p&gt;

</description>
        <pubDate>Wed, 24 Oct 2018 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2018/10/24/sub-50c-microcontrollers/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2018/10/24/sub-50c-microcontrollers/</guid>
        
        
      </item>
    
      <item>
        <title>Schematic for the &quot;Bustodephon&quot; brushed motor electronic speed controller (ESC)</title>
        <description>&lt;p&gt;I tried drawing the schematic for the common “Bustophedon” electronic speed controllers (ESC) for brushed motors.&lt;/p&gt;

&lt;div class=&quot;content-image&quot;&gt;
&lt;a href=&quot;/images/bustodephonschematic.png&quot;&gt;
&lt;img src=&quot;/generated/400-bustodephonschematic.png&quot; alt=&quot;&quot; srcset=&quot;    /generated/400-bustodephonschematic.png 400w, /images/bustodephonschematic.png 1028w&quot; sizes=&quot;400px&quot; /&gt;
&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;The circuit is fairly straightforward to follow.  The zener diode based regulator for the receiver power is a bit surprising - I would have thought another regulator would have been cheap enough instead of several components.  I’m guessing the separate supply is to shield the microcontroller from the receiver, especially since it would be easy to supply power from another ESC.&lt;/p&gt;

&lt;p&gt;The microcontroller has no markings, but there &lt;a href=&quot;https://www.lcsc.com/product-detail/_PMS153_C129129.html&quot;&gt;are&lt;/a&gt; &lt;a href=&quot;https://www.lcsc.com/product-detail/_SN8P2501D-SOP-14_C80639.html&quot;&gt;several&lt;/a&gt; very cheap microcontrollers which have a suitable pinout.&lt;/p&gt;

&lt;p&gt;I’ll have to analyze the microcontroller’s output to see whether it does anything special.&lt;/p&gt;

</description>
        <pubDate>Thu, 13 Sep 2018 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2018/09/13/brushed-bustophedon-esc-schematic/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2018/09/13/brushed-bustophedon-esc-schematic/</guid>
        
        
      </item>
    
      <item>
        <title>The FlySky iBus protocol</title>
        <description>&lt;p&gt;This is the FlySky iBus protocol that I’ve gleaned from &lt;a href=&quot;https://basejunction.wordpress.com/2015/08/23/en-flysky-i6-14-channels-part1/&quot;&gt;a blog post&lt;/a&gt; and a &lt;a href=&quot;https://github.com/aanon4/FlySkyIBus&quot;&gt;single library&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Data is transmitted as serial UART data, 115200bps, 8N1.  A message is sent every 7 milliseconds.  &lt;a href=&quot;https://www.banggood.com/818CH-Mini-Receiver-With-PPM-iBus-SBUS-Output-for-Flysky-i6-i6x-AFHDS-2A-Transmitter-p-1183313.html&quot;&gt;My receiver&lt;/a&gt; sends this over its white wire, and stops sending a few tenths of a second after the transmitter is switched off (unlike the PPM signal on the yellow wire, which keeps sending its last value).&lt;/p&gt;

&lt;p&gt;The first byte is 0x20, the second is 0x40.&lt;/p&gt;

&lt;p&gt;Next are 14 pairs of bytes, which is the channel value in little endian byte order.  The FS-i6 is a 6 channel receiver, so it fills in the first 6 values.  The remainder are set to 0x05DC.  My transmitter sends values between 0x3E8 and 0x7D0.&lt;/p&gt;

&lt;p&gt;Finally a 2 byte checksum is sent.  It’s in little endian byte order, it starts at 0xFFFF, from which every byte’s value is subtracted except for the checksum.&lt;/p&gt;

&lt;p&gt;I’ve written &lt;a href=&quot;https://github.com/33d/ibus-library&quot;&gt;a library&lt;/a&gt; to decode this data.  An Arduino could measure the time of the message start to improve detection of the message start.  One problem using an Arduino is that the board will interfere with programming - a resistor (maybe 10k) on the data line should help.&lt;/p&gt;

</description>
        <pubDate>Sun, 22 Oct 2017 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2017/10/22/flysky-ibus-protocol/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2017/10/22/flysky-ibus-protocol/</guid>
        
        
      </item>
    
      <item>
        <title>Build a Jekyll blog with Travis CI without granting write access</title>
        <description>&lt;p&gt;With the demise of Openshift Online and its free tier, I was looking for somewhere else to host my blog.  Even though it’s a &lt;a href=&quot;https://jekyllrb.com/&quot;&gt;Jekyll&lt;/a&gt; blog, it does some image resizing, so I can’t use Github’s native builder.  I should be able to use &lt;a href=&quot;https://travis-ci.org/&quot;&gt;Travis CI&lt;/a&gt; though, then push them to another Github repository for &lt;a href=&quot;https://help.github.com/categories/github-pages-basics/&quot;&gt;Pages&lt;/a&gt; hosting.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://docs.travis-ci.com/user/deployment/pages/&quot;&gt;Travis instructions for Github Pages&lt;/a&gt; instructions suggest you use Github personal access tokens for authentication, but that seems to give write access to all of my Github repositories - which I don’t want to do.&lt;/p&gt;

&lt;p&gt;You will need the &lt;a href=&quot;https://github.com/travis-ci/travis.rb&quot;&gt;command line client&lt;/a&gt; installed and logged in.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Generate a key pair for Travis to use when pushing&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; ssh-keygen -t rsa -b 4096 -f travis-key
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;Don’t commit the generated files!&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Create a repository on Github for the generated site to be pushed to.  In that repository, go to Settings, Deploy keys, then Add deploy key.  Copy in &lt;code&gt;travis-key.pub&lt;/code&gt; which you generated in the previous step, check “Enable write access”, then add the key.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The private key should be &lt;a href=&quot;https://docs.travis-ci.com/user/encrypting-files/&quot;&gt;encrypted&lt;/a&gt;.  From the blog repository:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; travis encrypt-file -r 33d/blog travis-key
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;where &lt;code&gt;travis-key&lt;/code&gt; is one of the files created earlier by &lt;code&gt;ssh-keygen&lt;/code&gt;.&lt;/p&gt;

    &lt;p&gt;This command will suggest you add a line to your &lt;code&gt;before_install&lt;/code&gt; section - do that.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Put at the end of &lt;code&gt;.travis.yml&lt;/code&gt;’s &lt;code&gt;before_install&lt;/code&gt;, to stop &lt;code&gt;ssh-add&lt;/code&gt; complaining about the key’s permissions:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; - chmod 400 ../travis-key
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Add this to &lt;code&gt;.travis.yml&lt;/code&gt;, to perform the Git push:&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;
 after_success:
  - eval &quot;$(ssh-agent -s)&quot;
  - ssh-add ../travis-key
  - git clone git@github.com:33d/blog-pages.git target
  - cp -pr _site/* target
  - git -C target checkout -b gh-pages
  - git -C target add .
  - git -C target commit -m &quot;$( date --utc --iso-8601=seconds )&quot;
  - git -C target push --force origin gh-pages
&lt;/code&gt;&lt;/p&gt;

    &lt;p&gt;I use a different repository for this, because I don’t want the build artifacts clogging the blog repository.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;You can see &lt;a href=&quot;https://github.com/33d/blog/blob/blog/.travis.yml&quot;&gt;my completed &lt;code&gt;.travis.yml&lt;/code&gt; file&lt;/a&gt;.&lt;/p&gt;

</description>
        <pubDate>Sun, 08 Oct 2017 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2017/10/08/jekyll-blog-travis-ci/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2017/10/08/jekyll-blog-travis-ci/</guid>
        
        
      </item>
    
      <item>
        <title>Check that your flash memory isn&#39;t fake</title>
        <description>&lt;p&gt;Here’s how I’ve checked that my flash memory (USB stick, SD card etc) isn’t fake.  The idea is to use a cipher to produce a psuedorandom stream, write its output to the flash memory, then genenrate the stream again comparing it to the card.&lt;/p&gt;

&lt;p&gt;First, find out how big the flash is:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cat /proc/paritions
major minor  #blocks  name
...
8       16   30736384 sdb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Some quick maths tells me the block size is 1024 bytes.  Next, use &lt;code&gt;openssl&lt;/code&gt; to encrypt some zeroes, writing the output to the card:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ dd if=/dev/zero bs=1024 count=30736384 | openssl enc -aes128 -k some-passworrd -nosalt | sudo tee /dev/sdb &amp;gt; /dev/null
30736384+0 records in
30736384+0 records out
31474057216 bytes (31 GB) copied, 989.076 s, 31.8 MB/s
tee: /dev/sdb: No space left on device
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I don’t know why it complains about no space, but the number of bytes written looks correct.&lt;/p&gt;

&lt;p&gt;(Change some-password to some other word.)  &lt;code&gt;-nosalt&lt;/code&gt; prevents openssl writing a header, which contains the password salt.  Because our encryption key (the &lt;code&gt;some-password&lt;/code&gt; above) doesn’t need to be secure, we don’t care about it, and will stop the same stream being output next time.&lt;/p&gt;

&lt;p&gt;Now check the result:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ dd if=/dev/zero bs=1024 count=30736384 | openssl enc -aes128 -k some-password -nosalt | sudo cmp - /dev/sdb
30736384+0 records in
30736384+0 records out
31474057216 bytes (31 GB) copied, 367.183 s, 85.7 MB/s
cmp: EOF on /dev/sdb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If it hits the end without complaining about differences, what’s on the card is what was produced again by the cipher stream, so the card contains the advertised flash chip.&lt;/p&gt;

</description>
        <pubDate>Sat, 11 Jul 2015 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2015/07/11/check-for-fake-flash/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2015/07/11/check-for-fake-flash/</guid>
        
        
      </item>
    
      <item>
        <title>Save space used by an Ubuntu VM by using the live CD, the slightly easier way</title>
        <description>&lt;p&gt;Yesterday I worked out how to use the Ubuntu live CD to save space on Ubuntu VMs.  It turns out you don’t need to change &lt;code&gt;initrd.lz&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Instead, all of the options in &lt;code&gt;casper.conf&lt;/code&gt; except &lt;code&gt;root_persistence&lt;/code&gt; can be specified on the kernel command line - simply add them (without the quotes) to &lt;code&gt;extlinux.conf&lt;/code&gt;.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Create a virtual machine with a hard disk of your choosing.  Boot the Ubuntu live CD in it.&lt;/li&gt;
  &lt;li&gt;Create a partition on the virtual hard disk for persistence, and make it bootable.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Format it, give it a label:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;$ sudo bash
# mkfs.ext2 /dev/sda1 -L overlay
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;

    &lt;pre&gt;&lt;code&gt;# mount /dev/sda1 /mnt
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;

    &lt;pre&gt;&lt;code&gt;# mkdir /mnt/boot
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;

    &lt;pre&gt;&lt;code&gt;# cp -p /cdrom/casper/vmlinuz.efi /mnt/boot
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;We need to &lt;a href=&quot;https://wiki.ubuntu.com/CustomizeLiveInitrd&quot;&gt;edit &lt;code&gt;/etc/casper.conf&lt;/code&gt; inside the initrd&lt;/a&gt;:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# cd /tmp
# mkdir i
# cd i
# lzcat /cdrom/casper/initrd.lz | cpio -i
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;now put in /tmp/i/etc/casper.conf (I found out the variables by looking through &lt;a href=&quot;http://bazaar.launchpad.net/~ubuntu-branches/ubuntu/trusty/casper/trusty/view/head:/scripts/casper&quot;&gt;&lt;code&gt;/usr/share/initramfs-tools/scripts/casper&lt;/code&gt;&lt;/a&gt;, which is run by the kernel command line’s &lt;code&gt;boot&lt;/code&gt; parameter.):&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# This file should go in /etc/casper.conf
# Supported variables are:
# USERNAME, USERFULLNAME, HOST, BUILD_SYSTEM, FLAVOUR
    
export USERNAME=&quot;user&quot;
export USERFULLNAME=&quot;Live session user&quot;
export HOST=&quot;vm&quot;
export BUILD_SYSTEM=&quot;Ubuntu&quot;
    
# USERNAME and HOSTNAME as specified above won&#39;t be honoured and will be set to
# flavour string acquired at boot time, unless you set FLAVOUR to any
# non-empty string.
    
export FLAVOUR=&quot;Ubuntu&quot;
    
export PERSISTENT=&quot;Yes&quot;
export root_persistence=&quot;overlay&quot;
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;You can customize your username and host name in this file too.  Note &lt;code&gt;root_persistence&lt;/code&gt; is the label we specified in step 3.  Now compress the initramfs:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# cd /tmp/i
# find . | cpio --quiet --dereference -o -H newc | lzma -7 &amp;gt; /mnt/boot/initrd.lz
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Now for a bootloader which uses the above stuff.  Install the extlinux package.  I grabbed the .deb &lt;a href=&quot;http://packages.ubuntu.com/trusty/extlinux&quot;&gt;from the package search&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Install extlinux:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# mkdir /mnt/boot/extlinux
# extlinux -i /mnt/boot/extlinux
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;Put this in &lt;code&gt;/mnt/boot/extlinux/extlinux.conf&lt;/code&gt;:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;DEFAULT linux
    
LABEL linux
KERNEL /boot/vmlinuz.efi
APPEND boot=casper initrd=/boot/initrd.lz noprompt
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The hard disk is probably missing a master boot record.&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# dd if=/usr/lib/syslinux/mbr.bin of=/dev/sda
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;Unmount &lt;code&gt;/mnt&lt;/code&gt; and reboot.&lt;/li&gt;
&lt;/ol&gt;

</description>
        <pubDate>Wed, 22 Apr 2015 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2015/04/22/save-space-used-by-an-ubuntu-vm-mk-ii/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2015/04/22/save-space-used-by-an-ubuntu-vm-mk-ii/</guid>
        
        
      </item>
    
      <item>
        <title>Save space used by an Ubuntu VM by using the live CD</title>
        <description>&lt;p&gt;I like to use VMs when doing things which might put stuff all over the filesystem or needs root access to install.  But at a few gigabytes each they quickly take up space.  I managed to use the live CD image as a base, which is compressed and can be shared among virtual machines.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Create a virtual machine with a hard disk of your choosing.  Boot the Ubuntu live CD in it.&lt;/li&gt;
  &lt;li&gt;Create a partition on the virtual hard disk for persistence, and make it bootable.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Format it, give it a label:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;$ sudo bash
# mkfs.ext2 /dev/sda1 -L overlay
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;

    &lt;pre&gt;&lt;code&gt;# mount /dev/sda1 /mnt
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;

    &lt;pre&gt;&lt;code&gt;# mkdir /mnt/boot
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;

    &lt;pre&gt;&lt;code&gt;# cp -p /cdrom/casper/vmlinuz.efi /mnt/boot
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;We need to &lt;a href=&quot;https://wiki.ubuntu.com/CustomizeLiveInitrd&quot;&gt;edit &lt;code&gt;/etc/casper.conf&lt;/code&gt; inside the initrd&lt;/a&gt; (&lt;em&gt;Edit&lt;/em&gt;: You don’t need to do this; see the end of the post):&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# cd /tmp
# mkdir i
# cd i
# lzcat /cdrom/casper/initrd.lz | cpio -i
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;now put in /tmp/i/etc/casper.conf (I found out the variables by looking through &lt;a href=&quot;http://bazaar.launchpad.net/~ubuntu-branches/ubuntu/trusty/casper/trusty/view/head:/scripts/casper&quot;&gt;&lt;code&gt;/usr/share/initramfs-tools/scripts/casper&lt;/code&gt;&lt;/a&gt;, which is run by the kernel command line’s &lt;code&gt;boot&lt;/code&gt; parameter.):&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# This file should go in /etc/casper.conf
# Supported variables are:
# USERNAME, USERFULLNAME, HOST, BUILD_SYSTEM, FLAVOUR
    
export USERNAME=&quot;user&quot;
export USERFULLNAME=&quot;Live session user&quot;
export HOST=&quot;vm&quot;
export BUILD_SYSTEM=&quot;Ubuntu&quot;
    
# USERNAME and HOSTNAME as specified above won&#39;t be honoured and will be set to
# flavour string acquired at boot time, unless you set FLAVOUR to any
# non-empty string.
    
export FLAVOUR=&quot;Ubuntu&quot;
    
export PERSISTENT=&quot;Yes&quot;
export root_persistence=&quot;overlay&quot;
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;You can customize your username and host name in this file too.  Note &lt;code&gt;root_persistence&lt;/code&gt; is the label we specified in step 3.  Now compress the initramfs:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# cd /tmp/i
# find . | cpio --quiet --dereference -o -H newc | lzma -7 &amp;gt; /mnt/boot/initrd.lz
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Now for a bootloader which uses the above stuff.  Install the extlinux package.  I grabbed the .deb &lt;a href=&quot;http://packages.ubuntu.com/trusty/extlinux&quot;&gt;from the package search&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Install extlinux:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# mkdir /mnt/boot/extlinux
# extlinux -i /mnt/boot/extlinux
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;Put this in &lt;code&gt;/mnt/boot/extlinux/extlinux.conf&lt;/code&gt;:&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;DEFAULT linux
    
LABEL linux
KERNEL /boot/vmlinuz.efi
APPEND boot=casper initrd=/boot/initrd.lz noprompt
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The hard disk is probably missing the master boot record code, so write that.&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;# dd if=/usr/lib/syslinux/mbr.bin of=/dev/sda
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;Unmount &lt;code&gt;/mnt&lt;/code&gt; and reboot.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;Edit:&lt;/em&gt; It turns out you don’t need to change &lt;code&gt;initrd.lz&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Instead, all of the options in &lt;code&gt;casper.conf&lt;/code&gt; except &lt;code&gt;root_persistence&lt;/code&gt; can be sp
ecified on the kernel command line - simply add them (without the quotes) to &lt;code&gt;ex
tlinux.conf&lt;/code&gt;, like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;APPEND boot=casper initrd=/boot/initrd.lz noprompt username=user hostname=host
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You also need to label your hard disk partition &lt;code&gt;casper-rw&lt;/code&gt;.&lt;/p&gt;

</description>
        <pubDate>Tue, 21 Apr 2015 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2015/04/21/save-space-used-by-an-ubuntu-vm/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2015/04/21/save-space-used-by-an-ubuntu-vm/</guid>
        
        
      </item>
    
      <item>
        <title>Back up the flash of a Huawei Mediapad 7 Lite</title>
        <description>&lt;p&gt;I recently purchased a Huawei Mediapad 7 Lite 4GB very cheaply on clearance.  It’s based on a Rockchip RK2918, which there are tools for to read and write the flash directly.  Before I start trying to hack it, I should get a backup of what’s already on it.&lt;/p&gt;

&lt;p&gt;I found &lt;a href=&quot;http://valentijn.sessink.nl/?p=382&quot;&gt;a post&lt;/a&gt; which describes how the flash of a different Rockchip tablet can be backed up.  Maybe I can catch the USB device being recognized as I restart the tablet.&lt;/p&gt;

&lt;p&gt;So, in one terminal:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tail -f /var/log/kern.log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and then turn off the tablet.  The battery charge screen appears, and there’s nothing useful yet.&lt;/p&gt;

&lt;p&gt;So I held down Volume + and the power button, the screen goes blank.  So I switched it off.  But wait: in the kernel log:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Aug 24 22:29:24 xpee kernel: [ 2187.324056] usb 1-5: new high-speed USB device number 7 using ehci-pci
Aug 24 22:29:25 xpee kernel: [ 2187.869050] usb 1-5: unable to get BOS descriptor
Aug 24 22:29:25 xpee kernel: [ 2187.869674] usb 1-5: New USB device found, idVendor=2207, idProduct=290a
Aug 24 22:29:25 xpee kernel: [ 2187.869681] usb 1-5: New USB device strings: Mfr=0, Product=0, SerialNumber=0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and a quick search for vendor 2207… Rockchip!  Interesting…&lt;/p&gt;

&lt;p&gt;Following &lt;a href=&quot;http://valentijn.sessink.nl/?p=382&quot;&gt;the post mentioned earlier&lt;/a&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo ./rkflashtool r 0x0000 0x2000 &amp;gt; dump^C
$ strings dump
PARM
FIRMWARE_VER:0.2.3
MACHINE_MODEL:MediaPad 7 Lite
MACHINE_ID:007
MANUFACTURER:HUAWEI
MAGIC: 0x5041524B
ATAG: 0x60000800
MACHINE: 2929
CHECK_MASK: 0x80
KERNEL_IMG: 0x60408000
COMBINATION_KEY: 0,6,A,1,0
CMDLINE: console=ttyS1,115200n8n androidboot.console=ttyS1 init=/init initrd=0x62000000,0x800000 mtdparts=rk29xxnand:0x00002000@0x00002000(misc),0x00004000@0x00004000(kernel),0x00008000@0x00008000(boot),0x00008000@0x00010000(recovery),0x00002000@0x00018000(backup),0x00006000@0x0001a000(oeminfo),0x00004000@0x00020000(vrcb),0x00008000@0x00024000(reserved),0x00100000@0x0002c000(cust),0x000e6000@0x0012c000(system),0x00080000@0x00212000(cache),0x00008000@0x00292000(userdata),0x00002000@0x0029a000(kpanic),-@0x0029c000(user)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I notice that this text appears several times, so I’d better keep this in mind.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://www.kernel.org/doc/menuconfig/drivers-mtd-Kconfig.html#MTD_CMDLINE_PARTS&quot;&gt;Linux MTD documentation describes what &lt;code&gt;mtdparts&lt;/code&gt; is for&lt;/a&gt;.
So after copying the &lt;code&gt;mtdparts&lt;/code&gt; bit to a file, with a bit of Perl magic I can dump each “part” to a file:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ perl -pe &#39;s/([0-9a-fx-]*)@([a-f0-9x]*)\(([a-z]*)\).?/\2 \1 \3\n/g&#39; &amp;lt; mtdparts | while read off len name ; do sudo ./rkflashtool r $off $len 2&amp;gt;/dev/null | xz &amp;gt; $name.xz ; done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;But what about the last one, which lists the size as &lt;code&gt;-&lt;/code&gt;?  I’ll try reading a block which shouldn’t exist:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo ./rkflashtool r 0xfffffffd 1 | hexdump -C
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It doesn’t seem to matter what I change the offset to, it seems to output part of the first block at some seemingly arbitrary offset.  Also, the offset seems to be the start offset in 512 byte blocks, but trying to read one block returns 0x4000 bytes of data.  Looking at &lt;a href=&quot;http://sourceforge.net/p/rkflashtool/Git/ci/2bd62daeb5e63f4f1f92d1876b053a2be8cf428c/tree/rkflashtool.c#l248&quot;&gt;the source&lt;/a&gt; suggests that it reads blocks of 0x4000 bytes, so that’s the minimum it’s going to return.  I tried hacking the code to fail &lt;a href=&quot;http://sourceforge.net/p/rkflashtool/Git/ci/2bd62daeb5e63f4f1f92d1876b053a2be8cf428c/tree/doc/protocol.txt#l46&quot;&gt;if the error flag in the response&lt;/a&gt; is set, but that didn’t help.&lt;/p&gt;

&lt;p&gt;But &lt;a href=&quot;http://sourceforge.net/p/rkflashtool/Git/ci/2bd62daeb5e63f4f1f92d1876b053a2be8cf428c/tree/doc/protocol.txt#l94&quot;&gt;the bottom of the protocol description lists a FlashInfo structure&lt;/a&gt;, which contains the number of blocks of flash, but I notice that command hasn’t been implemented.  I hope they didn’t leave it out because it bricks devices… (&lt;a href=&quot;https://github.com/33d/rkflashtool/commit/3955541b14adbb8ad55198e870165752a52e4271&quot;&gt;hack hack hack&lt;/a&gt;) I tried implementing it, but got this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo ./rkflashtool l | hexdump -C
00000000  00 00 80 00 00 08 08 18  21 04 01 00 00 00 00 00  |........!.......|
00000010  44 4e 41 4e 20 01 65 00  02 00 00 00 01 01 01 00  |DNAN .e.........|
00000020  01 01 18 21 04 10 08 70  00 10 00 00 00 08 00 00  |...!...p........|
00000030  00 01 00 00 00 00 10 00  00 00 80 00 00 00 80 00  |................|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000060  00 00 00 00 00 00 00 00  30 00 10 80 d0 60 70 00  |........0....`p.|
00000070  30 60 10 80 d0 60 70 00  80 80 78 00 78 00 15 80  |0`...`p...x.x...|
00000080  85 00 e0 05 e0 06 10 85  35 00 00 00 00 00 00 00  |........5.......|
00000090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000200
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;No permutations of those first 6 bytes and their endianness seem to produce anything useful, so I’ll try something else.&lt;/p&gt;

&lt;p&gt;Maybe &lt;code&gt;/proc/mtd&lt;/code&gt; will yield some secrets:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;1|shell@android:/ $ cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00400000 00004000 &quot;misc&quot;
mtd1: 00800000 00004000 &quot;kernel&quot;
mtd2: 01000000 00004000 &quot;boot&quot;
mtd3: 01000000 00004000 &quot;recovery&quot;
mtd4: 00400000 00004000 &quot;backup&quot;
mtd5: 00c00000 00004000 &quot;oeminfo&quot;
mtd6: 00800000 00004000 &quot;vrcb&quot;
mtd7: 01000000 00004000 &quot;reserved&quot;
mtd8: 20000000 00004000 &quot;cust&quot;
mtd9: 1cc00000 00004000 &quot;system&quot;
mtd10: 10000000 00004000 &quot;cache&quot;
mtd11: 01000000 00004000 &quot;userdata&quot;
mtd12: 00400000 00004000 &quot;kpanic&quot;
mtd13: 9a800000 00004000 &quot;user&quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Everything in the “size” column seems to be 512*what was listed in &lt;code&gt;mtdparts&lt;/code&gt;.  This makes the &lt;code&gt;user&lt;/code&gt; part 0x4D4000 long.  I can finally back up that part:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo ./rkflashtool r 0x0029c000 0x4d4000 2&amp;gt;user.log | xz &amp;gt; user.xz
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I ran &lt;code&gt;fsck.ext4 -c&lt;/code&gt; on the result, and it was happy, so I guess I have the right length.&lt;/p&gt;

&lt;p&gt;But I think it might be better to just grab the whole lot:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo ./rkflashtool r 0 0x800000 2&amp;gt;all.log | xz &amp;gt; all.xz
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;where 0x800000 is 4GB/512, and is a bit bigger than the 0x0029c000+0x4d4000 that I calculated earlier.  I can verify various parts:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ diff &amp;lt;(xzcat user.xz | dd bs=512 ) &amp;lt;( xzcat all.xz | dd bs=512 count=$((0x4d4000))     skip=$((0x29c000)) )
5062656+0 records in
5062656+0 records out
2592079872 bytes (2.6 GB) copied, 56.8184 s, 45.6 MB/s
5062656+0 records in
5062656+0 records out
2592079872 bytes (2.6 GB) copied, 56.8161 s, 45.6 MB/s
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;diff&lt;/code&gt; produced no output, so the data are the same.  I’ll keep a copy of &lt;code&gt;all.xz&lt;/code&gt; and the output from &lt;code&gt;./rkflashtool p&lt;/code&gt; and &lt;code&gt;cat /proc/mtd&lt;/code&gt;, which will let me recover whatever I need to.&lt;/p&gt;

</description>
        <pubDate>Mon, 25 Aug 2014 00:00:00 +0000</pubDate>
        <link>http://yourdomain.com/posts/2014/08/25/huawei-mediapad-7-lite-backup/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2014/08/25/huawei-mediapad-7-lite-backup/</guid>
        
        
      </item>
    
      <item>
        <title>Running a Z-machine on an AVR</title>
        <description>&lt;p&gt;Can you make a &lt;a href=&quot;http://en.wikipedia.org/wiki/Z-machine&quot;&gt;Z-machine&lt;/a&gt; console - a virtual machine for text adventure games -  complete with screen and keyboard on an AVR?&lt;/p&gt;

&lt;p&gt;No. Well, probably not on a ATmega328P.&lt;/p&gt;

&lt;p&gt;I &lt;a href=&quot;ftp://sunsite.unc.edu/pub/Linux/games/textrpg/zipinfocm-2.0.linux.tar.gz&quot;&gt;got the code for ZIP&lt;/a&gt;, and stripped out all of the code for reading files and displaying stuff on the screen.  This let me compile it with avr-gcc.&lt;/p&gt;

&lt;p&gt;I looked at the result of objdump:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ avr-objdump -h zip_linux

zip_linux:     file format elf32-avr

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .data         000001e4  00800100  0000579c  00005830  2**0
                  CONTENTS, ALLOC, LOAD, DATA
  1 .text         0000579c  00000000  00000000  00000094  2**1
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  2 .bss          00000ac8  008002e4  008002e4  00005a14  2**0
                  ALLOC
  3 .stab         0000dcec  00000000  00000000  00005a14  2**2
                  CONTENTS, READONLY, DEBUGGING
  4 .stabstr      00003aad  00000000  00000000  00013700  2**0
                  CONTENTS, READONLY, DEBUGGING
  5 .comment      00000022  00000000  00000000  000171ad  2**0
                  CONTENTS, READONLY
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The good news is that the code (the .text section) fits into 22k.  That leaves 10k for the screen rendering code (probably from &lt;a href=&quot;http://www.batsocks.co.uk/products/Other/TellyMate.htm&quot;&gt;TellyMate&lt;/a&gt;), the keyboard and the SD card code.&lt;/p&gt;

&lt;p&gt;The .data section is quite small too, which means there aren’t many strings in the interpreter itself.&lt;/p&gt;

&lt;p&gt;The problem is the .bss section, which gets copied to RAM on startup.  It’s 2760 bytes, much more than the 2048 which this chip has.&lt;/p&gt;

&lt;p&gt;Let’s look at this further:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ avr-objdump -t zip_linux | grep bss | sort -t $&#39;\t&#39; -k 2
...

0080030c g     O .bss    00000004 pc
00800da6 g     O .bss    00000006 __iob
00000114 g       .text    00000010 __do_clear_bss
00800552 g     O .bss    0000004e lookup_table
00800436 l     O .bss    00000100 record_name
00800332 l     O .bss    00000100 save_name
008005a0 g     O .bss    00000800 stack
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There’s a 2048 byte stack, which fills the entire memory!  The Infocom games &lt;a href=&quot;http://www.gnelson.demon.co.uk/zspec/sect06.html&quot;&gt;might only need a 1k stack&lt;/a&gt;, which will help.&lt;/p&gt;

&lt;p&gt;Tellymate has a 38x25 screen, which needs 950 bytes.  This could be brought down to 10 lines, but games might be tricky to play.  The ZX80 didn’t store a full line if it didn’t fill the width of the screen, but adventure games tend to be wordy so this won’t help much.&lt;/p&gt;

&lt;p&gt;An SD card library needs about 600 bytes of RAM, which blows the budget.  We’d have to go without a filesystem on the SD card, because it takes up too much flash space.  It sounds like the 512 byte buffer might be optional.&lt;/p&gt;

&lt;p&gt;4k of RAM should be plenty.  But with ARM chips being much cheaper than the larger AVRs, that might be the way to go - if I can sort out the &lt;a href=&quot;http://sourcegate.wordpress.com/2012/11/04/code-to-produce-video-signals-on-the-stm32l-discovery/&quot;&gt;jittering image problems&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;You might be able to squeeze the interpreter only onto the chip, and communicate with it via its serial port, or another AVR running TellyMate.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Update:&lt;/strong&gt; It turns out I wasn’t the only one to look at this - Rossum &lt;a href=&quot;http://rossumblog.com/2011/04/19/zork-for-the-microtouch/&quot;&gt;implemented it on the 2560-byte ATmega32U4&lt;/a&gt;, but needed to store a 1MB swap file on the SD card!  I don’t know why you need that much - maybe you don’t - but I forgot to include dynamic memory and room for the stack.&lt;/p&gt;
</description>
        <pubDate>Sun, 06 Apr 2014 06:44:08 +0000</pubDate>
        <link>http://yourdomain.com/posts/2014/04/06/running-a-z-machine-on-an-avr/</link>
        <guid isPermaLink="true">http://yourdomain.com/posts/2014/04/06/running-a-z-machine-on-an-avr/</guid>
        
        <category>advenure</category>
        
        <category>arduino</category>
        
        <category>avr</category>
        
        <category>infocom</category>
        
        <category>text</category>
        
        <category>tv</category>
        
        <category>video</category>
        
        <category>z-machine</category>
        
        
      </item>
    
  </channel>
</rss>
